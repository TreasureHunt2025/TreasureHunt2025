<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>宝探し企画くじ引き</title>
  <style>
    :root {
      --bg1: #214b86;
      --bg2: #11325c;
      --panel: #173864;
      --edge: #2f5a94;
      --muted: #c7d6e6;
      --txt: #f2f7fc;
      --c1: #d4af37;
      --c2: #60a5fa;
      --c3: #22d3ee;
      --c4: #34d399;
      --c5: #64748b;
      --accent: #61b0ff;
      --accentGlow: rgba(97, 176, 255, .35);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, var(--bg1) 0%, var(--bg2) 70%);
      color: var(--txt);
      -webkit-text-size-adjust: 100%;
    }

    /* remove iOS blue highlight/focus */
    button,
    input {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      outline: none;
    }

    button:focus,
    button:focus-visible,
    input:focus,
    input:focus-visible {
      outline: none !important;
      box-shadow: none;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 96px
    }

    header {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px
    }

    h1 {
      margin: 0;
      font-size: clamp(20px, 2.2vw, 28px);
      letter-spacing: .02em;
      text-shadow: 0 2px 10px rgba(0, 0, 0, .25)
    }

    .btn {
      border: 1px solid var(--edge);
      background: #1b4275;
      color: #f2f7fc;
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .25)
    }

    .main {
      display: grid;
      gap: 16px
    }

    @media(min-width:980px) {
      .main {
        grid-template-columns: 1.1fr .9fr
      }
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--edge);
      border-radius: 16px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, .35)
    }

    .left {
      padding: 16px;
      display: grid;
      gap: 16px
    }

    .right {
      padding: 16px;
      display: grid;
      gap: 12px
    }

    .bigBtns {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px
    }

    .bigBtns button {
      font-weight: 900;
      font-size: clamp(20px, 3vw, 28px);
      padding: 22px 12px;
      border-radius: 18px;
      border: 2px solid #2a4a79;
      background: linear-gradient(180deg, #2a5d9c, #21497c);
      color: #fff;
      cursor: pointer;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .4);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .28), inset 0 0 0 1px rgba(255, 255, 255, .06);
      transition: transform .06s, box-shadow .2s, border-color .2s, opacity .2s;
    }

    .bigBtns button:active {
      transform: translateY(1px)
    }

    .bigBtns button.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accentGlow), 0 10px 24px rgba(0, 0, 0, .28);
    }

    .bigBtns button[disabled] {
      opacity: .55;
      cursor: not-allowed
    }

    .start {
      justify-self: center
    }

    .start button {
      font-size: clamp(22px, 3.2vw, 30px);
      font-weight: 900;
      padding: 18px 32px;
      border-radius: 999px;
      border: 2px solid #2b4f84;
      background: radial-gradient(120% 120% at 20% 10%, #3773c8, #244a86);
      box-shadow: 0 12px 36px rgba(28, 88, 190, .45);
      color: #fff;
      cursor: pointer;
      transition: transform .06s, box-shadow .2s, opacity .2s;
    }

    .start button:active {
      transform: translateY(1px)
    }

    .start button:disabled {
      opacity: .55;
      cursor: not-allowed
    }

    .rollerWrap {
      display: grid;
      justify-items: center;
      gap: 10px
    }

    .roller {
      width: min(100%, 1100px);
      display: grid;
      place-items: center;
      border-radius: 22px;
      border: 2px solid #2b4e80;
      background: radial-gradient(120% 160% at 20% 10%, #21416f, #18325a);
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, .05), 0 24px 70px rgba(0, 0, 0, .35);
      position: relative;
      overflow: hidden;
      height: var(--roller-h, auto);
      aspect-ratio: 5/2;
    }

    .roller::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(to bottom, rgba(255, 255, 255, .08), rgba(255, 255, 255, 0) 40%);
    }

    .digit {
      font-weight: 1000;
      letter-spacing: .02em;
      text-shadow: 0 6px 16px rgba(0, 0, 0, .35);
      line-height: 1;
      padding-top: .1em;
      transition: transform .05s;
      -webkit-user-select: none;
      user-select: none;
      font-size: var(--digit-fs, min(22vw, 240px));
    }

    .digit.flash {
      animation: flash .7s ease-out
    }

    @keyframes flash {
      0% {
        transform: scale(1);
        filter: brightness(1)
      }

      30% {
        transform: scale(1.22);
        filter: brightness(1.35)
      }

      100% {
        transform: scale(1);
        filter: brightness(1)
      }
    }

    .results {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center
    }

    .chip {
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 900;
      border: 1px solid rgba(255, 255, 255, .15);
      cursor: pointer;
      color: #0b0f14
    }

    .chip.sel {
      box-shadow: 0 0 0 3px var(--accent) inset
    }

    .actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      z-index: 30
    }

    .actions .confirm {
      font-weight: 1000;
      font-size: clamp(22px, 3.2vw, 34px);
      padding: 18px 28px;
      border-radius: 16px;
      border: 2px solid #2b4f84;
      background: radial-gradient(120% 120% at 20% 10%, #3773c8, #244a86);
      color: #fff;
      box-shadow: 0 12px 34px rgba(28, 88, 190, .45), inset 0 0 0 1px rgba(255, 255, 255, .18);
      min-width: min(90%, 520px);
      cursor: pointer;
      transition: transform .06s, box-shadow .2s, opacity .2s;
    }

    .actions .confirm:active {
      transform: translateY(1px)
    }

    .actions .confirm[disabled] {
      opacity: .55;
      cursor: not-allowed
    }

    .muted {
      color: var(--muted)
    }

    .invGrid {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 10px;
      align-items: center
    }

    .tierName {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 900
    }

    .dot {
      width: 16px;
      height: 16px;
      border-radius: 50%
    }

    .qty {
      font-variant-numeric: tabular-nums;
      justify-self: end;
      min-width: 2ch;
      text-align: right
    }

    .invBtn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a3f62;
      background: #1b4275;
      color: #fff;
      cursor: pointer
    }

    .invInput {
      width: 100px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #2a3f62;
      background: #122744;
      color: #fff
    }

    .selectedBanner {
      display: none;
      justify-content: center;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 2px dashed rgba(255, 255, 255, .2);
      background: rgba(0, 0, 0, .15);
      z-index: 10
    }

    .selectedBadge {
      font-size: clamp(22px, 3vw, 28px);
      font-weight: 1000;
      padding: 10px 16px;
      border-radius: 999px;
      color: #0b0f14
    }

    .selectedLabel {
      font-size: clamp(18px, 2vw, 22px);
      color: var(--muted)
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0)
      }

      25% {
        transform: translateX(-3px)
      }

      75% {
        transform: translateX(3px)
      }
    }

    .shake {
      animation: shake .24s linear
    }

    /* ===== Landscape: perfect-fit with taller roller ===== */
    @media (orientation: landscape) {
      .wrap {
        max-width: none;
        padding: 0
      }

      header {
        position: sticky;
        top: 0;
        z-index: 20;
        padding: 6px 12px;
        margin: 0;
        background: linear-gradient(180deg, rgba(0, 0, 0, .18), rgba(0, 0, 0, 0));
        backdrop-filter: blur(3px);
      }

      h1 {
        font-size: clamp(16px, 1.8vw, 22px)
      }

      .main {
        display: block
      }

      .playArea {
        min-height: 100svh;
        padding: clamp(8px, 2vh, 16px);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .left {
        padding: 0;
        background: transparent;
        box-shadow: none;
        border: 0
      }

      .panel.left {
        background: transparent
      }

      .bigBtns {
        width: min(96vw, 1200px);
        margin: 0 auto 4px
      }

      .bigBtns button {
        font-size: clamp(18px, 2.2vw, 26px);
        padding: 16px 10px;
        border-radius: 16px
      }

      .rollerWrap {
        width: min(96vw, 1200px);
        margin: 0 auto;
        gap: 6px
      }

      .roller {
        width: 100%;
        aspect-ratio: auto;
      }

      /* override to allow tall box */
      .digit {
        font-size: var(--digit-fs, min(26vh, 26vw, 300px));
      }

      .start button {
        font-size: clamp(18px, 2.4vw, 26px);
        padding: 12px 24px
      }

      .selectedBanner {
        width: min(96vw, 1200px);
        margin: 0 auto
      }

      .results {
        width: min(96vw, 1200px);
        margin: 0 auto;
        gap: 8px
      }

      .chip {
        padding: 10px 12px
      }

      .actions {
        position: sticky;
        bottom: calc(var(--safe-bottom) + 8px);
        padding-bottom: var(--safe-bottom);
        width: min(96vw, 1200px);
        margin: 0 auto;
        margin-top: auto;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, .18));
        border-radius: 14px;
      }

      .inventoryPanel {
        margin-top: 0;
        padding: 16px;
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
      }
    }

    /* Error banner */
    #errBanner {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      display: none;
      padding: 10px 14px;
      background: #b91c1c;
      color: #fff;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header id="appHeader">
      <h1>宝探し企画くじ引き</h1>
      <button id="mute" class="btn" aria-pressed="false">🔊 サウンド</button>
    </header>

    <main class="main">
      <section class="panel left playArea" id="play">
        <div class="bigBtns" id="bigBtns">
          <button id="pick1">1回引く</button>
          <button id="pick2">2回引く</button>
          <button id="pick3">3回引く</button>
        </div>

        <div class="rollerWrap">
          <div class="roller" id="roller">
            <div class="digit" id="digit">–</div>
          </div>
          <div class="start" id="startWrap">
            <button id="startBtn" disabled>スタート</button>
          </div>
        </div>

        <div class="selectedBanner" id="selectedBanner">
          <span class="selectedLabel" id="selectedLabel">選択中：</span>
          <span class="selectedBadge" id="selectedBadge" style="background:#999">—</span>
        </div>

        <div class="results" id="results"></div>
        <div class="actions" id="actions" style="display:none">
          <span class="muted" id="hint">表示された結果から1つ選んでください</span>
          <button id="confirmBtn" class="confirm" disabled>確定</button>
        </div>
      </section>

      <section class="panel right inventoryPanel">
        <h3 style="margin:0 0 6px">在庫状況</h3>
        <div class="invGrid" id="inv"></div>
        <p class="muted" style="margin:.5em 0 0">※数値を直接編集するか±で調整できます。</p>
      </section>
    </main>
  </div>

  <div id="errBanner"></div>

  <script>
    // ===== Error surface (helps on device) =====
    (function () {
      const banner = document.getElementById('errBanner');
      window.addEventListener('error', e => {
        banner.textContent = 'エラー: ' + (e && e.message ? e.message : '不明なエラー');
        banner.style.display = 'block';
      });
      window.addEventListener('unhandledrejection', e => {
        banner.textContent = 'エラー: ' + (e && e.reason && e.reason.message ? e.reason.message : 'Promise でエラー');
        banner.style.display = 'block';
      });
    })();

    // === logic ===
    const KEY = 'lottery_num_state_v13';
    const DEFAULT_INV = { 1: 5, 2: 18, 3: 35, 4: 82, 5: 160 };
    let inv = loadInv();
    let plannedDraws = 0, doneDraws = 0, pendingResults = [], selectedTier = null;
    let running = false, muted = false, controlsLocked = false;

    // Audio
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let actx = null, master = null;
    function ensureAudio() {
      if (!actx) {
        actx = new AudioCtx({ latencyHint: 'interactive' });
        master = actx.createGain();
        master.gain.value = 0.9;
        master.connect(actx.destination);
      }
    }
    async function unlockAudio() {
      try { ensureAudio(); if (actx && actx.state !== 'running') await actx.resume(); } catch (e) { }
    }
    function tone(freq = 520, time = 0.10, type = 'sine', gain = 0.16) {
      if (muted) return;
      ensureAudio();
      const o = actx.createOscillator(), g = actx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.setValueAtTime(0.0001, actx.currentTime);
      g.gain.linearRampToValueAtTime(gain, actx.currentTime + 0.012);
      g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime + time);
      o.connect(g).connect(master);
      o.start(); o.stop(actx.currentTime + time);
    }
    function tick() { tone(450, 0.08, 'sine', 0.18); }
    function thump() { tone(200, 0.18, 'sine', 0.18); }
    function chime() {
      if (muted) return; ensureAudio();
      const t = actx.currentTime;
      [[523, 0], [659, 0.1], [784, 0.22]].forEach(([f, off]) => {
        const o = actx.createOscillator(), g = actx.createGain();
        o.type = 'sine'; o.frequency.value = f;
        g.gain.setValueAtTime(0.0001, t + off);
        g.gain.linearRampToValueAtTime(0.06, t + off + 0.03);
        g.gain.exponentialRampToValueAtTime(0.0001, t + off + 0.5);
        o.connect(g).connect(master);
        o.start(t + off); o.stop(t + off + 0.52);
      });
    }

    // cache DOM
    const resultsEl = document.getElementById('results');
    const startBtn = document.getElementById('startBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const actions = document.getElementById('actions');
    const hint = document.getElementById('hint');
    const btn1 = document.getElementById('pick1'), btn2 = document.getElementById('pick2'), btn3 = document.getElementById('pick3');
    const selectedBanner = document.getElementById('selectedBanner');
    const selectedBadge = document.getElementById('selectedBadge');
    const selectedLabel = document.getElementById('selectedLabel');
    const roller = document.getElementById('roller');
    const digit = document.getElementById('digit');

    // ===== Animation (restored) =====
    function shade(hex, amt) {
      const c = hex.replace('#', ''); const n = parseInt(c, 16);
      let r = (n >> 16) & 255, g = (n >> 8) & 255, b = n & 255;
      const f = (x) => Math.max(0, Math.min(255, Math.floor(amt >= 0 ? x + (255 - x) * amt : x * (1 + amt))));
      return '#' + ((1 << 24) + (f(r) << 16) + (f(g) << 8) + f(b)).toString(16).slice(1);
    }
    function colorFor(t) { return getComputedStyle(document.documentElement).getPropertyValue(`--c${t}`).trim(); }

    function animateToResult(result) {
      return new Promise(resolve => {
        const t0 = performance.now();
        const dur = 4000; // 4s演出
        const accel = 0.28, decel = 0.48;
        const nums = [1, 2, 3, 4, 5];
        let lastSwitch = t0;
        function easeIn(x) { return x * x; }
        function easeOutQuint(x) { return 1 - Math.pow(1 - x, 5); }
        function frame(now) {
          const p = Math.min(1, (now - t0) / dur);
          let spd;
          if (p < accel) { spd = 1.0 + 3.0 * easeIn(p / accel); }
          else if (p > 1 - decel) { spd = 0.6 + 0.9 * (1 - easeOutQuint((1 - p) / decel)); }
          else { spd = 3.8; }
          const gap = 1000 / (9 * spd);
          if (now - lastSwitch > gap) {
            const n = nums[Math.floor(Math.random() * nums.length)];
            digit.textContent = n;
            digit.style.color = '#0b0f14';
            roller.style.background = `linear-gradient(180deg, ${shade(colorFor(n), 0.2)}, ${shade(colorFor(n), -0.22)})`;
            lastSwitch = now;
            tick();
          }
          if (p < 1) requestAnimationFrame(frame);
          else {
            digit.textContent = result;
            digit.classList.remove('flash'); void digit.offsetWidth; digit.classList.add('flash');
            roller.style.background = `linear-gradient(180deg, ${shade(colorFor(result), 0.12)}, ${shade(colorFor(result), -0.25)})`;
            thump(); setTimeout(chime, 80);
            resolve();
          }
        }
        requestAnimationFrame(frame);
      });
    }

    // Dynamic perfect-fit for landscape
    function fitLayout() {
      const header = document.getElementById('appHeader');
      const play = document.getElementById('play');
      const big = document.getElementById('bigBtns');
      const startWrap = document.getElementById('startWrap');
      const vpH = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      const padTop = parseFloat(getComputedStyle(play).paddingTop) || 0;
      const padBot = parseFloat(getComputedStyle(play).paddingBottom) || 0;
      const headerH = header.offsetHeight || 0;
      const bigH = big.offsetHeight || 0;
      const startH = startWrap.offsetHeight || 0;
      const bannerH = (selectedBanner.style.display !== 'none' ? selectedBanner.offsetHeight : 0);
      const resultsH = resultsEl.offsetHeight || 0;
      const actionsH = (actions.style.display !== 'none' ? actions.offsetHeight : 72) + 16; // reserve when hidden

      const avail = vpH - headerH - padTop - padBot - bigH - startH - bannerH - resultsH - actionsH - 10;
      const rollerH = Math.max(200, Math.min(avail, Math.floor(vpH * 0.80)));
      roller.style.setProperty('--roller-h', rollerH + 'px');

      const fs = Math.max(140, Math.min(Math.floor(rollerH * 0.56), 320));
      digit.style.setProperty('--digit-fs', fs + 'px');
    }
    const fitLater = () => requestAnimationFrame(fitLayout);
    window.addEventListener('load', fitLater);
    window.addEventListener('resize', fitLater);
    window.addEventListener('orientationchange', () => setTimeout(fitLayout, 200));

    // ===== Core lottery =====
    function loadInv() { try { const raw = localStorage.getItem(KEY); if (!raw) return { ...DEFAULT_INV }; const obj = JSON.parse(raw); return { ...DEFAULT_INV, ...obj }; } catch (e) { return { ...DEFAULT_INV }; } }
    function saveInv() { localStorage.setItem(KEY, JSON.stringify(inv)); }
    function totalLeft() { return Object.values(inv).reduce((a, b) => a + (b | 0), 0); }
    function weightedPick() {
      const tot = totalLeft(); if (tot <= 0) return 5;
      let r = Math.floor(Math.random() * tot);
      for (let t = 1; t <= 5; t++) { const c = inv[t] | 0; if (r < c) return t; r -= c; }
      return 5;
    }

    function selectCountButton(n) {
      [btn1, btn2, btn3].forEach((b, i) => {
        const k = i + 1; const sel = (k === n);
        b.classList.toggle('selected', sel);
        b.setAttribute('aria-pressed', String(sel));
        if (sel) { b.classList.remove('shake'); b.style.transform = 'scale(0.98)'; setTimeout(() => b.style.transform = '', 140); }
      });
    }
    function setControlsLocked(lock) {
      controlsLocked = lock;
      [btn1, btn2, btn3].forEach(b => { b.disabled = lock; });
      const remain = Math.max(0, plannedDraws - doneDraws);
      startBtn.disabled = lock || (remain <= 0);
    }
    function setDraws(n) {
      setControlsLocked(false);
      if (totalLeft() <= 0) { alert('在庫がありません'); return; }
      plannedDraws = n; doneDraws = 0; pendingResults = []; selectedTier = null;
      selectedBanner.style.display = 'none';
      startBtn.disabled = false; updateStartLabel();
      resultsEl.innerHTML = '';
      actions.style.display = 'none';
      confirmBtn.disabled = true;
      digit.textContent = '–';
      roller.style.background = 'radial-gradient(120% 160% at 20% 10%, #21416f, #18325a)';
      selectCountButton(n);
      fitLayout();
    }
    function updateStartLabel() {
      const remain = Math.max(0, plannedDraws - doneDraws);
      startBtn.textContent = remain > 0 ? `スタート（残り ${remain}）` : 'スタート';
      startBtn.disabled = controlsLocked || remain <= 0;
    }
    async function runOneDraw() {
      try { await unlockAudio(); } catch (_) { }
      if (running) return;
      if (doneDraws >= plannedDraws) return;
      running = true; startBtn.disabled = true;
      try {
        const pick = weightedPick();
        await animateToResult(pick);
        pendingResults.push(pick);
        doneDraws++;
        addChip(pick);
        const remain = plannedDraws - doneDraws;
        if (remain > 0) {
          [btn1, btn2, btn3].forEach(b => b.disabled = true);
          updateStartLabel();
          actions.style.display = 'none';
          confirmBtn.disabled = true;
          hint.textContent = '続けてスタートを押してください';
          startBtn.disabled = false; // allow next draw
        } else {
          updateStartLabel();
          actions.style.display = 'flex';
          hint.textContent = '表示された結果から1つ選んでください';
          setControlsLocked(true);
        }
      } catch (e) {
        const banner = document.getElementById('errBanner');
        banner.textContent = 'エラー: ' + (e && e.message ? e.message : e);
        banner.style.display = 'block';
        // graceful fallback: finish this draw immediately
        const pick = 5;
        digit.textContent = pick;
      } finally {
        running = false;
        fitLayout();
      }
    }
    function addChip(tier) {
      const chip = document.createElement('span');
      chip.className = 'chip'; chip.style.background = colorFor(tier);
      chip.textContent = `${tier}等`;
      chip.onclick = () => { selectChip(chip); };
      resultsEl.appendChild(chip);
      fitLayout();
    }
    function selectChip(chipEl) {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('sel'));
      chipEl.classList.add('sel');
      const tier = Number(chipEl.textContent[0]);
      selectedTier = tier;
      const left = inv[tier] | 0;
      const remain = Math.max(0, plannedDraws - doneDraws);

      selectedBadge.style.background = colorFor(tier);
      selectedBadge.textContent = `${tier}等`;
      selectedBanner.style.display = 'flex';

      if (remain > 0) {
        selectedLabel.textContent = '確定候補（まだ抽選中）';
        hint.textContent = `続けてスタートを押してください（残り ${remain}）`;
        actions.style.display = 'none';
        confirmBtn.disabled = true;
        updateStartLabel();
      } else {
        selectedLabel.textContent = '確定候補：';
        hint.textContent = left > 0 ? `${tier}等 を授与（残り ${left}）` : `${tier}等 は在庫切れ。他を選んでください`;
        actions.style.display = 'flex';
        confirmBtn.disabled = left <= 0;
        setControlsLocked(true);
      }
      fitLayout();
    }
    function confirmAward() {
      if (selectedTier == null) { alert('授与する等級を選んでください'); return; }
      if ((inv[selectedTier] | 0) <= 0) { alert('在庫切れです'); return; }
      inv[selectedTier]--; saveInv(); renderInv();
      plannedDraws = 0; doneDraws = 0; pendingResults = []; selectedTier = null;
      startBtn.disabled = true; confirmBtn.disabled = true;
      [btn1, btn2, btn3].forEach(b => { b.classList.remove('selected'); b.disabled = false; });
      resultsEl.innerHTML = '';
      selectedBanner.style.display = 'none';
      hint.textContent = '確定しました';
      setControlsLocked(false);
      fitLayout();
    }

    function el(tag, cls, html) { const x = document.createElement(tag); if (cls) x.className = cls; if (html != null) x.innerHTML = html; return x; }
    function btn(txt, fn) { const b = document.createElement('button'); b.textContent = txt; b.onclick = fn; return b; }

    const invEl = document.getElementById('inv');
    function renderInv() {
      invEl.innerHTML = '';
      const rows = [
        { id: 1, name: '1等', color: colorFor(1) },
        { id: 2, name: '2等', color: colorFor(2) },
        { id: 3, name: '3等', color: colorFor(3) },
        { id: 4, name: '4等', color: colorFor(4) },
        { id: 5, name: '5等', color: colorFor(5) },
      ];
      for (const r of rows) {
        const name = el('div', 'tierName', `<span class="dot" style="background:${r.color}"></span><span>${r.name}</span>`);
        const qty = el('div', 'qty', String(inv[r.id] | 0));
        const minus = btn('−', () => { inv[r.id] = Math.max(0, (inv[r.id] | 0) - 1); qty.textContent = inv[r.id]; saveInv(); });
        minus.className = 'invBtn';
        const plus = btn('+', () => { inv[r.id] = (inv[r.id] | 0) + 1; qty.textContent = inv[r.id]; saveInv(); });
        plus.className = 'invBtn';
        const set = document.createElement('input'); set.type = 'number'; set.className = 'invInput'; set.value = inv[r.id] | 0; set.min = '0';
        set.onchange = () => { inv[r.id] = Math.max(0, Math.floor(Number(set.value) || 0)); qty.textContent = inv[r.id]; saveInv(); };
        invEl.append(name, qty, minus, plus, set);
      }
    }

    // Bind
    document.getElementById('pick1').onclick = () => setDraws(1);
    document.getElementById('pick2').onclick = () => setDraws(2);
    document.getElementById('pick3').onclick = () => setDraws(3);
    document.getElementById('startBtn').onclick = runOneDraw;
    document.getElementById('confirmBtn').onclick = confirmAward;
    document.getElementById('mute').onclick = async (e) => {
      muted = !muted; e.currentTarget.setAttribute('aria-pressed', String(muted));
      e.currentTarget.textContent = muted ? '🔇 ミュート' : '🔊 サウンド';
      if (!muted) { try { await unlockAudio(); tone(600, 0.08, 'sine', 0.18); } catch (_) { } }
    };

    renderInv();
  </script>
</body>

</html>